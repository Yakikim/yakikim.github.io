---
layout: mynote
tags: [notes, memo, op] 
created: 2021-07-05 10:17
modified: 2021-07-05 10:17
type: Document
title: תזכיר  2021-07-05
---
Week Of: [[2021-07-04]]
[[2021-07-05]]

# תזכיר נסיון העברת אפליקציית נסיעות לשרת הAPEX
[[home]]/[[Open University]]/[[Memos]]/[[APEX]]

## רקע\תיאור
כחלק מבדיקת ההיתכנות, אנו ננסה להעביר אפליקציה קיימת מסביבת ERP NEWT לשרת האפליקציה המרוחק.

## אובייקטים ושינויים
### Application Process
כל Process יש לעבור ולבדוק אם הוא אמור לרוץ על ה-DB האפליקטיבי או לרוץ על ה-DB המרוחק.
### Application Definition
יש לתקן\לבדוק אם צריך את ה- APPS_INITIALIZE
### Authorizations
יש לתקן ולהפוך לשירות את כל הגישה למערכות כ"א שלהם ובכללם את הרשאת המזכירה

### Grants
```sql
GRANT SELECT ON fnd_user TO apexrest;
GRANT EXECUTE ON fnd_global TO apexrest;
GRANT EXECUTE ON fnd_profile TO apexrest;
GRANT SELECT ON OP_EMPLOYEE_DATA_MV TO apexrest;
GRANT EXECUTE ON APEX_ERP_GENERAL_PKG TO apexrest;
```

### אובייקטים מ-ORA
בסביבת TESTA תוקם סכמה שתיקרא REST_KOACH_TEMP לשם **הדגמה והתנסות** בצריכת שירותים. (לשם הקמת השירותים העתידית, תוקם בהמשך סכמת REST_KOACH ותושקע מחשבה במידול השירותים כך ששירותים ייוצאו באופן שיענה על צרכי כלל הארגון ולא כ"סתימת חורים") 
#### שירות עבור היררכיית עובדים
```sql
SELECT EMP.USERLOGIN AS USERNAME,
       EMP_HRR.EMP_NAME,
       EMP.EMPLOYEEID AS MIS_ZEHUT,
       EMP.EMAIL,
       EMP.PHONE_3,
       EMP_HRR.EMP_ORIGIN,
       EMP_HRR.EMP_ORIGIN_DESC,
       EMP_HRR.EMP_DEPTNO,
       EMP_HRR.EMP_DEPT_DESC,
       EMP_HRR.JOB_POSSITION,
       EMP_HRR.JOB_POS_DESC,
       EMP_HRR.EMP_STATUS,
       EMP_HRR.EMP_STATUS_DESC,
       EMP_HRR.DIRECT_MNGR_NAME,
       MGR_DIRECT.EMAIL         DIR_MGR_EMAIL,
       MGR_DIRECT.USERLOGIN     DIR_MGR_USERNAME,
       MGR_DIRECT.EMPLOYEEID    DIR_MGR_ZEHUT,
       EMP_HRR.LEVEL_THREE_NAME TOP_MGR_NAME,
       TOP_MGR.EMAIL            TOP_MGR_EMAIL,
       TOP_MGR.USERLOGIN        TOP_MGR_UN,
       TOP_MGR.EMPLOYEEID       TOP_MGR_ZEHUT
  FROM KOACH.EMPLOYEE_DETAILS_TAB EMP_HRR,
       KOACH.EMPLOYEES            EMP,
       KOACH.EMPLOYEES            MGR_DIRECT,
       KOACH.EMPLOYEES            TOP_MGR
WHERE EMP_HRR.MIS_ZEHUT = EMP.EMPLOYEEID
   AND EMP_HRR.DIRECT_MANAGER = MGR_DIRECT.EMPLOYEEID(+)
   AND EMP_HRR.LEVEL_THREE_MNGR = TOP_MGR.EMPLOYEEID(+);
   ```
 ####  שירות עבור פרטי תפקיד (מחלקה תקציבית)
 ```sql
 select * from 
 KOACH.AVTPPIRTEY_TAFKID_UC6
```
#### הגדרות ORDS

## Create GET Web Services

```sql
BEGIN
  ORDS.define_module(
    p_module_name    => 'v1',
    p_base_path      => 'v1/',
    p_items_per_page => 0);
  
  ORDS.define_template(
   p_module_name    => 'v1',
   p_pattern        => 'emp/hier/');

  ORDS.define_handler(
    p_module_name    => 'v1',
    p_pattern        => 'emp/hier/',
    p_method         => 'GET',
    p_source_type    => ORDS.source_type_collection_feed,
    p_source         => q'# 
SELECT EMP.USERLOGIN AS USERNAME,
       EMP_HRR.EMP_NAME,
       EMP.EMPLOYEEID AS MIS_ZEHUT,
       EMP.EMAIL,
       EMP.PHONE_3,
       EMP_HRR.EMP_ORIGIN,
       EMP_HRR.EMP_ORIGIN_DESC,
       EMP_HRR.EMP_DEPTNO,
       EMP_HRR.EMP_DEPT_DESC,
       EMP_HRR.JOB_POSSITION,
       EMP_HRR.JOB_POS_DESC,
       EMP_HRR.EMP_STATUS,
       EMP_HRR.EMP_STATUS_DESC,
       EMP_HRR.DIRECT_MNGR_NAME,
       MGR_DIRECT.EMAIL         DIR_MGR_EMAIL,
       MGR_DIRECT.USERLOGIN     DIR_MGR_USERNAME,
       MGR_DIRECT.EMPLOYEEID    DIR_MGR_ZEHUT,
       EMP_HRR.LEVEL_THREE_NAME TOP_MGR_NAME,
       TOP_MGR.EMAIL            TOP_MGR_EMAIL,
       TOP_MGR.USERLOGIN        TOP_MGR_UN,
       TOP_MGR.EMPLOYEEID       TOP_MGR_ZEHUT
  FROM KOACH.EMPLOYEE_DETAILS_TAB EMP_HRR,
       KOACH.EMPLOYEES            EMP,
       KOACH.EMPLOYEES            MGR_DIRECT,
       KOACH.EMPLOYEES            TOP_MGR
WHERE EMP_HRR.MIS_ZEHUT = EMP.EMPLOYEEID
   AND EMP_HRR.DIRECT_MANAGER = MGR_DIRECT.EMPLOYEEID(+)
   AND EMP_HRR.LEVEL_THREE_MNGR = TOP_MGR.EMPLOYEEID(+)
#',
    p_items_per_page => 0);
    

  COMMIT;
END;
/
```


## [[ORDS]] Roles and Privileges

```sql
DECLARE
  l_roles     OWA.VC_ARR;
  l_modules   OWA.VC_ARR;
  l_patterns  OWA.VC_ARR;
BEGIN
  ORDS.create_role(
    p_role_name => 'ERP system'
  );

  l_roles(1)   := 'ERP system';
  l_modules(1) := 'v1';
  l_patterns(1):= 'emp/hier/*';
  ORDS.DEFINE_PRIVILEGE(
      p_privilege_name => 'View Data',
      p_roles          => l_roles,
      p_patterns       => l_patterns,
      p_modules        => l_modules,
      p_label          => 'View Privilages',
      p_description    => 'Allow access to the Employees data.',
      p_comments       => NULL);      

  COMMIT;
END;
/

```
### Viewing the Data  
###### Display the role.  
>
>
```sql
SELECT id, name
FROM   user_ords_roles
WHERE  name = 'ERP system';
```
>
|  ID   |  NAME   |
| -- | -- |
|10321 |	ERP system |


###### Display the privilege information.  
>
```sql
SELECT id, name
FROM   user_ords_privileges
WHERE  name = 'View Data';
```
 >
 |  ID  |  NAME  |
 | -- | -- |
 |	10322	|	 View Data	|

###### Display the privilege-role relationship.  
>
```sql
SELECT privilege_id, privilege_name, role_id, role_name
FROM   user_ords_privilege_roles
WHERE  role_name = 'ERP system';
```
>
| PRIVILEGE_ID | PRIVILEGE_NAME | ROLE_ID | ROLE_NAME |
| -------- | ---------- | ----- | ------ |
|	10322| 	View Data	 | 10321	|ERP system |


###### Display the mapping information.  
>
```sql
SELECT privilege_id, name, pattern
FROM   user_ords_privilege_mappings
WHERE  name = 'View Data';
```
>
|PRIVILEGE_ID|	NAME|	PATTERN|
|--|--|
|10322	| View Data| 	emp/hier/* |



## OAuth :  Create Client Credentials

```sql
BEGIN
  OAUTH.create_client(
    p_name            => 'ERP_CLIENT',
    p_grant_type      => 'client_credentials',
    p_owner           => 'OpenUniversity',
    p_description     => 'A client for GET',
    p_support_email   => 'yakiki@openu.as.il',
    p_privilege_names => 'View Data'
  );

  COMMIT;
END;
/
```
###### Display client details.  
>
```sql
SELECT id, name, client_id, client_secret
FROM   user_ords_clients;
```
>
|ID	| NAME|	CLIENT_ID |	CLIENT_SECRET |
|--|--|--|--|
|	10330 |	ERP_CLIENT	| INgibh1UEMtfVumOy5PIfQ..	| NomryYcNUeVN7QRpko0y9w.. |




###### Display client-privilege relationship.
>
```sql
SELECT name, client_name
FROM   user_ords_client_privileges;
```
>
|NAME|	CLIENT_NAME|
|--|--|
| View Data	| ERP_CLIENT|

### Grant Role to Client
```sql
BEGIN
  OAUTH.grant_client_role(
    p_client_name => 'ERP_CLIENT',
    p_role_name   => 'ERP system'
  );

  COMMIT;
END;
/
```

###### Display client-role relationship.
>
```sql
SELECT client_name, role_name
FROM   user_ords_client_roles;
```
>
|CLIENT_NAME	|ROLE_NAME|
| -- | -- |
| ERP_CLIENT |	ERP system|


## מסקנות ופעולות
- [ ] #task יש לקבל הרשאות לפתיחת שירותים מרוחקים והחלטה לגבי המדיניות
- [ ] #task יש לקבל יכולת הענקת הרשאות (לפחות בסביבת TESTA - לצורך הבדיקות)
- [ ] #task יש להתקין את ה-LDAP
- [X]  

#memo 
#op/memo